name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * 5'  # Friday at 05:00 UTC

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Linters
        run: make lint

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Required for keyless signing
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Cosign
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: sigstore/cosign-installer@v3

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Determine Image Tag
        id: tag
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            SAFE_BRANCH=$(echo "${{ github.head_ref || github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g')
            echo "tag=latest-$SAFE_BRANCH" >> $GITHUB_OUTPUT
          fi

      # PRODUCTION-GRADE UNIFIED BUILD (via Makefile)
      # We build everything in one shot to ensure local-base-internal-build resolution.
      # CRITICAL: Attestations (SLSA) must be OFF for 'load' to work with internal aliases.
      - name: Unified Bake (Build & Load)
        run: |
          make build \
            BUILDER_NAME=${{ steps.buildx.outputs.name }} \
            IMAGE_TAG=${{ steps.tag.outputs.tag }} \
            ENABLE_ATTESTATIONS=false

      - name: Run Tests & Security Scan
        run: |
          make test \
            BUILDER_NAME=${{ steps.buildx.outputs.name }} \
            IMAGE_TAG=${{ steps.tag.outputs.tag }} \
            ENABLE_ATTESTATIONS=false
          
          make scan \
            IMAGE_TAG=${{ steps.tag.outputs.tag }}

      - name: Log in to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      # Final Release Step (Main Only)
      # Here we build with PUSH and ATTESTATIONS enabled.
      - name: Release & Sign (SLSA)
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          REPO="${{ secrets.DOCKER_HUB_USER }}/gemini-cli-toolbox"
          
          # 1. Build and Push with Attestations
          # Note: We use raw docker buildx here because the Makefile 'build' target uses --load by default
          docker buildx bake hub cli cli-preview \
            --builder ${{ steps.buildx.outputs.name }} \
            --set "*.cache-from=type=gha" \
            --set "*.cache-to=type=gha,mode=max" \
            --push
          
          # 2. Sign all public images
          cosign sign --yes $REPO:$TAG-stable
          cosign sign --yes $REPO:$TAG-preview
          cosign sign --yes $REPO:$TAG-hub
          
          make docker-readme

  all-checks-passed:
    name: All Checks Passed
    needs: [lint, build-and-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Success
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: exit 1
