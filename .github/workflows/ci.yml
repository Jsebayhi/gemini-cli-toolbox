name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 5 * * 5'
    - cron: '0 12 * * 6'

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Ruff
        run: pip install ruff
      - name: Run Linting
        run: make lint

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Cosign
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: sigstore/cosign-installer@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Registry & Prefix
        id: meta
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
             echo "REPO_PREFIX=${{ secrets.DOCKER_HUB_USER }}/gemini-cli-toolbox" >> $GITHUB_OUTPUT
             echo "BAKE_ACTION=--push" >> $GITHUB_OUTPUT
             echo "ENABLE_ATTESTATIONS=true" >> $GITHUB_OUTPUT
          else
             # Generate unique UUID for ephemeral registry
             UUID=$(uuidgen | tr '[:upper:]' '[:lower:]')
             echo "REPO_PREFIX=ttl.sh/gemini-cli-toolbox-${UUID}" >> $GITHUB_OUTPUT
             echo "BAKE_ACTION=--push" >> $GITHUB_OUTPUT
             echo "ENABLE_ATTESTATIONS=true" >> $GITHUB_OUTPUT
          fi

      - name: Build All Images (SLSA Enabled)
        env:
          REPO_PREFIX: ${{ steps.meta.outputs.REPO_PREFIX }}
          BAKE_ACTION: ${{ steps.meta.outputs.BAKE_ACTION }}
          ENABLE_ATTESTATIONS: ${{ steps.meta.outputs.ENABLE_ATTESTATIONS }}
        run: make build

      - name: Run Tests
        env:
          REPO_PREFIX: ${{ steps.meta.outputs.REPO_PREFIX }}
          # We need to ensure tests run against the images we just pushed.
          # The Makefile uses BAKE_ACTION from env, so if we pass it, it tries to push again.
          # But we want to 'run' them.
          # Actually, 'make test' invokes 'docker buildx bake' again.
          # If we keep BAKE_ACTION=--push, it just verifies cache and pushes (fast).
          # Then 'docker run' pulls from the registry.
          BAKE_ACTION: ${{ steps.meta.outputs.BAKE_ACTION }}
          ENABLE_ATTESTATIONS: ${{ steps.meta.outputs.ENABLE_ATTESTATIONS }}
        run: make test

      - name: Run Security Scan
        env:
          REPO_PREFIX: ${{ steps.meta.outputs.REPO_PREFIX }}
        run: make scan

      - name: Log in to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Sign Images (SLSA)
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        env:
          REPO_PREFIX: ${{ steps.meta.outputs.REPO_PREFIX }}
        run: |
           # Basic signing loop for main images
           for img in "hub" "cli"; do
             # Sign the latest tag
             cosign sign --yes "${REPO_PREFIX}/${img}:latest"
           done
