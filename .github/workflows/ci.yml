name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Google releases @google/gemini-cli ~Thursday 20:00 UTC.
    # We build Friday morning to catch the new version immediately.
    - cron: '0 5 * * 5'  # Friday at 05:00 UTC
    - cron: '0 12 * * 6' # Saturday at 12:00 UTC (Fallback/Hotfix catch)

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ruff
        run: pip install ruff

      - name: Validate Bash Scripts
        run: |
          echo "::group::Syntax Check"
          bash -n bin/gemini-toolbox bin/gemini-hub
          find images -name "*.sh" -print0 | xargs -0 -I {} bash -n "{}"
          echo "::endgroup::"
          
          echo "::group::ShellCheck"
          shellcheck bin/gemini-toolbox bin/gemini-hub
          find images -name "*.sh" -print0 | xargs -0 shellcheck
          echo "::endgroup::"

      - name: Validate Python
        run: |
          echo "::group::Ruff & Syntax"
          find images/gemini-hub -name "*.py" -exec python -m py_compile {} +
          ruff check images/gemini-hub
          echo "::endgroup::"

  build:
    name: Build & Cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Bake All Images (Populate Cache)
        uses: docker/bake-action@v5
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          ENABLE_ATTESTATIONS: false
        with:
          targets: default
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
          load: true

  test-bash:
    name: Bash Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run Bash Automated Tests
        run: |
          mkdir -p coverage/bash
          # Bake uses GHA cache from the build job
          export GITHUB_REF="${{ github.ref }}"
          export GITHUB_EVENT_NAME="${{ github.event_name }}"
          make test-bash

      - name: Upload Bash Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-bash
          path: coverage/bash/

  test-hub:
    name: Hub Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run Hub Automated Tests
        run: |
          mkdir -p coverage/python
          # Bake uses GHA cache from the build job
          export GITHUB_REF="${{ github.ref }}"
          export GITHUB_EVENT_NAME="${{ github.event_name }}"
          make test-hub

      - name: Upload Hub Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-python
          path: coverage/python/

  scan:
    name: Security Scan
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Vulnerability Scan
        run: |
          # Bake uses GHA cache from the build job
          export GITHUB_REF="${{ github.ref }}"
          export GITHUB_EVENT_NAME="${{ github.event_name }}"
          make build # Ensure images are loaded in this runner's daemon
          make scan

  publish:
    name: Publish & Sign
    needs: [test-bash, test-hub, scan]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Required for keyless signing
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Publish All Images
        run: |
          # Use Bake to push images with official tags
          export GITHUB_REF="${{ github.ref }}"
          export GITHUB_EVENT_NAME="${{ github.event_name }}"
          export REPO_PREFIX="${{ secrets.DOCKER_HUB_USER }}/gemini-cli-toolbox"
          export RELEASE_TYPE="suffix"
          export ENABLE_ATTESTATIONS="true"
          
          # Fetch versions for tagging
          make build # Ensure local images are available for version extraction
          VERSION=$(docker run --rm --entrypoint="" gemini-cli-toolbox/cli:latest gemini --version | tr -d '\r')
          PREVIEW_VER=$(docker run --rm --entrypoint="" gemini-cli-toolbox/cli-preview:latest gemini --version | tr -d '\r')
          
          # Push everything
          docker buildx bake hub --push
          GEMINI_VERSION="$VERSION" docker buildx bake cli --push
          GEMINI_VERSION="$PREVIEW_VER" docker buildx bake cli-preview --push

      - name: Sign & Verify Images
        run: |
          REPO="${{ secrets.DOCKER_HUB_USER }}/gemini-cli-toolbox"
          
          # Extract versions again
          VERSION=$(docker run --rm --entrypoint="" gemini-cli-toolbox/cli:latest gemini --version | tr -d '\r')
          PREVIEW_VER=$(docker run --rm --entrypoint="" gemini-cli-toolbox/cli-preview:latest gemini --version | tr -d '\r')

          # Sign
          cosign sign --yes $REPO:latest-stable
          cosign sign --yes $REPO:$VERSION-stable
          cosign sign --yes $REPO:latest-preview
          cosign sign --yes $REPO:$PREVIEW_VER-preview
          cosign sign --yes $REPO:latest-hub

          # Verify (Ensures the supply chain is actually protected)
          cosign verify $REPO:latest-stable --certificate-identity-regexp "https://github.com/Jsebayhi/gemini-cli-toolbox/.github/workflows/ci.yml@refs/heads/main" --certificate-oidc-issuer "https://token.actions.githubusercontent.com"
          cosign verify $REPO:latest-preview --certificate-identity-regexp "https://github.com/Jsebayhi/gemini-cli-toolbox/.github/workflows/ci.yml@refs/heads/main" --certificate-oidc-issuer "https://token.actions.githubusercontent.com"
          cosign verify $REPO:latest-hub --certificate-identity-regexp "https://github.com/Jsebayhi/gemini-cli-toolbox/.github/workflows/ci.yml@refs/heads/main" --certificate-oidc-issuer "https://token.actions.githubusercontent.com"

      - name: Update Docker Hub Description
        run: make docker-readme

  update-coverage-badge:
    name: Update Coverage Badge
    needs: [test-bash, test-hub]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Bash Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-bash
          path: coverage/bash/

      - name: Download Hub Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-python
          path: coverage/python/

      - name: Generate Bypass Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Compute Global Coverage & Update Badge
        run: |
          python3 scripts/update_coverage.py

      - name: Commit Coverage Badge Update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          token: ${{ steps.generate_token.outputs.token || github.token }}
          commit_message: "docs: update coverage badge [skip ci]"
          file_pattern: README.md

      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@v4
        continue-on-error: true
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          repository: ${{ secrets.DOCKER_HUB_USER }}/gemini-cli-toolbox
          short-description: "Gemini CLI sandbox: Multi-Profile, Remote Access, Docker, VS Code Companion, Git Worktree."
          readme-filepath: ./README_DOCKER.md

  all-checks-passed:
    name: All Checks Passed
    needs: [lint, build, test-bash, test-hub, scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check dependency status
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: exit 1
      - name: Success
        run: echo "All checks passed successfully."
