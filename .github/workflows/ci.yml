name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Google releases @google/gemini-cli ~Thursday 20:00 UTC.
    # We build Friday morning to catch the new version immediately.
    - cron: '0 5 * * 5'  # Friday at 05:00 UTC
    - cron: '0 12 * * 6' # Saturday at 12:00 UTC (Fallback/Hotfix catch)

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Linters
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          pip install ruff

      - name: Validate Bash Scripts (Syntax)
        run: |
          # Check Wrapper Scripts
          bash -n bin/gemini-toolbox
          bash -n bin/gemini-hub
          
          # Check Entrypoints
          find images -name "*.sh" -print0 | xargs -0 -I {} bash -n "{}"

      - name: Validate Bash Scripts (Lint)
        run: |
          # strict check
          shellcheck bin/gemini-toolbox bin/gemini-hub
          find images -name "*.sh" -print0 | xargs -0 shellcheck

      - name: Validate Python (Syntax)
        run: |
          find images/gemini-hub -name "*.py" -exec python -m py_compile {} +

      - name: Validate Python (Lint)
        run: |
          # Check images/gemini-hub
          ruff check images/gemini-hub

      - name: Run Tests (Gemini Hub)
        run: |
          cd images/gemini-hub
          # Build the test image (includes dev dependencies)
          docker build -t gemini-hub-test -f tests/Dockerfile .
          # Run tests (enforces 90% coverage via CMD)
          docker run --rm gemini-hub-test

  build:
    name: Build & Test
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Make
        run: sudo apt-get update && sudo apt-get install -y make

      - name: Build & Tag (CI Mode)
        run: make ci

      - name: Set Scan Targets
        id: scan_targets
        run: |
          echo "CLI_IMAGE=$(make print-image-cli)" >> $GITHUB_ENV
          echo "PREVIEW_IMAGE=$(make print-image-preview)" >> $GITHUB_ENV
          echo "HUB_IMAGE=$(make print-image-hub)" >> $GITHUB_ENV

      - name: Security Scan (Gemini CLI)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.CLI_IMAGE }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL'

      - name: Security Scan (Gemini Preview)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.PREVIEW_IMAGE }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL'

      - name: Security Scan (Gemini Hub)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.HUB_IMAGE }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL'

      - name: Log in to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Publish to Docker Hub (New Repo)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          REPO="${{ secrets.DOCKER_HUB_USER }}/gemini-cli-toolbox"
          
          # --- Stable ---
          # Tags: :latest-stable, :X.Y.Z-stable
          docker tag gemini-cli-toolbox/cli:latest $REPO:latest-stable
          docker push $REPO:latest-stable
          
          VERSION=$(docker run --rm --entrypoint="" gemini-cli-toolbox/cli:latest gemini --version | tr -d '\r')
          docker tag gemini-cli-toolbox/cli:latest $REPO:$VERSION-stable
          docker push $REPO:$VERSION-stable

          # --- Preview ---
          # Tags: :latest-preview, :X.Y.Z-preview
          docker tag gemini-cli-toolbox/cli-preview:latest $REPO:latest-preview
          docker push $REPO:latest-preview
          
          PREVIEW_VER=$(docker run --rm --entrypoint="" gemini-cli-toolbox/cli-preview:latest gemini --version | tr -d '\r')
          docker tag gemini-cli-toolbox/cli-preview:latest $REPO:$PREVIEW_VER-preview
          docker push $REPO:$PREVIEW_VER-preview

          # --- Hub ---

          # Tags: :latest-hub, :X.Y.Z-hub (Hub versioning is independent, but we'll use a date or static version for now or just latest)
          # For simplicity and since it's an internal tool, we just push latest-hub for now.
          docker tag gemini-cli-toolbox/hub:latest $REPO:latest-hub
          docker push $REPO:latest-hub

      - name: Prepare Docker Hub README
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: make docker-readme

      - name: Update Docker Hub Description (New Repo)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peter-evans/dockerhub-description@v4
        continue-on-error: true
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          repository: ${{ secrets.DOCKER_HUB_USER }}/gemini-cli-toolbox
          short-description: "Gemini CLI sandbox: Multi-Profile, Remote Access, Docker, VS Code Companion, Git Worktree."
          readme-filepath: ./README_DOCKER.md
