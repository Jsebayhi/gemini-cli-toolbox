# Project Context: Gemini CLI Toolbox

This document provides high-level operational context for AI agents working on the repository as a whole.

## 1. Project Overview
A modular "Gemini CLI Toolbox" repository containing multiple self-contained Dockerized CLI tools. Each tool resides in `images/<tool-name>` and manages its own lifecycle.

## 2. Repository Structure

| Directory | Purpose |
| :--- | :--- |
| `bin/` | **User Interface.** Wrapper scripts (`gemini-toolbox`) that users invoke directly. |
| `images/` | **Components.** Source code for each Docker image. |
| `images/gemini-cli/` | **Gemini CLI.** [See Component Context](images/gemini-cli/GEMINI.md) |
| `Makefile` | **Orchestrator.** Master makefile for global build tasks. |

## 3. Global Workflows

### Adding a New Tool
1. Create `images/<new-tool>/`.
2. Add `Dockerfile`, `Makefile`, and `GEMINI.md` specific to that tool.
3. Add a wrapper script in `bin/`.
4. Register the tool in the root `README.md`.

### Global Build
```bash
make build
```

## 4. Core Mandates

### Documentation is Code
*   **Mandate:** You must strictly maintain all documentation (`README.md`, `GEMINI.md`, `adr/*`) in sync with code changes.
*   **Trigger:** Any time you rename files, change architecture, modify workflows, or discover new gotchas, you **MUST** update the corresponding documentation in the same turn.
*   **User-Facing Rule:** If you add a new feature (e.g., a flag, a command, a capability) or change behavior, you **MUST** update the root `README.md` to reflect this immediately. Do not leave features undocumented.
*   **Why:** This project relies on the "Golden Artifact" pattern where the documentation is the source of truth for future sessions.

### Context Management
*   **Rule:** When working on a specific tool, **load its specific `GEMINI.md`**.
*   **Why:** The root context is generic; the component context contains the critical "gotchas" for that specific image.

### CLI Flags & Autocompletion
*   **Rule:** If you add, remove, or modify CLI flags in `bin/gemini-toolbox` or `bin/gemini-hub`, you **MUST** immediately update the corresponding script in `completions/`.
*   **Why:** Stale completion scripts frustrate users.

### Pull Request Protocol
*   **Rule:** Do **NOT** merge Pull Requests unless explicitly instructed by the user.
*   **Process:** Create branch -> Implement -> Push -> Open PR -> **STOP**.
*   **Why:** The user often wants to review the PR diff before merging.

## 5. Naming Strategy

### Consistency Mandate
To ensure reliable discovery (e.g., via Gemini Hub) and ease of debugging, all tools must adhere to a **strict 1:1 naming scheme**. The Docker Container Name and the Tailscale Hostname must be identical.

| Context | Pattern | Example |
| :--- | :--- | :--- |
| **Docker Container** | `gem-{PROJECT}-{TYPE}-{ID}` | `gem-my-app-geminicli-a1b2` |
| **Tailscale Hostname** | `gem-{PROJECT}-{TYPE}-{ID}` | `gem-my-app-geminicli-a1b2` |

### Components
*   **Prefix `gem-`**: Mandatory namespace to avoid collisions with host resources or other VPN nodes.
*   **`PROJECT`**: The lowercased, sanitized basename of the current workspace directory (non-alphanumeric chars replaced by hyphens).
*   **`TYPE`**: The session mode. Standard values: `geminicli` (Chat), `bash` (Shell). **Must NOT contain hyphens** to ensure robust parsing.
*   **`ID`**: A unique suffix (e.g., first 8 chars of UUID) generated by the toolbox script.

### Parsing Logic
Discovery tools (like `gemini-hub`) rely on this structure.
*   **Source of Truth:** The `gemini-toolbox` script generates the `GEMINI_SESSION_ID` and passes it to the container. The container **must** use this ID as-is.
*   **Parsing:** Split by `-`.
    *   Prefix: Index 0 (`gem`)
    *   Suffix: Index -1 (`ID`)
    *   Type: Index -2 (`TYPE`)
    *   Project: Join `1` to `-2` (`PROJECT`)

### Environment Variables
*   **Prefix Requirement:** All environment variables impacting tool behavior must be namespaced.
    *   `GEMINI_TOOLBOX_*`: For the CLI wrapper and general toolbox behavior.
    *   `GEMINI_HUB_*`: For the Hub service.
*   **Why:** Prevents collisions with user environment variables and clarifies scope.

## 6. Configuration Profiles
*   **Concept:** Users can maintain multiple configuration directories (profiles) for different contexts (e.g., Work, Personal).
*   **Location:** Default is `~/.gemini`. Additional profiles are typically in `~/.gemini-profiles/`.
*   **Selection:** Use `gemini-toolbox --config <path>` to select a profile.
*   **Customization:** A profile can define persistent runtime arguments (volumes, flags) by placing a file named `extra-args` in its root. See [ADR-0021](adr/0021-configuration-profiles-and-extra-args.md).

## 9. CI/CD & Image Tagging
*   **Dynamic Tagging:** Images are tagged based on the active git branch.
    *   `main` branch → `latest` tag.
    *   Feature branches → `latest-{branch_name}` tag (sanitized).
    *   **Why:** Allows parallel development without `latest` tag collisions on local machines or CI runners.
*   **Security Scanning:** The `make scan` target in each component handles Trivy scans.
    *   **CI Usage:** The CI pipeline invokes `make scan` (instead of calling Trivy directly) to ensure it scans the *exact* image tag built by the previous step, respecting dynamic tagging rules.
    *   **Rule:** Do not hardcode image tags in `.github/workflows/ci.yml` for scanning steps. Delegate to `make scan`.

## 10. Known Peculiarities & Gotchas

*   **Docker-out-of-Docker:** The agent controls the **Host** daemon. Paths mounted must be absolute and exist on the host. `localhost` inside the container refers to the container, not the host (unless `--net=host` is used).
*   **Terminal Colors:** We explicitly pass `COLORTERM` and `TERM` env vars to ensure TrueColor support in remote sessions.

## 8. Documentation Architecture

### File Roles & Expectations

| File | Audience | Purpose & Tone |
| :--- | :--- | :--- |
| `README.md` | **Everyone** | **The Hook.** Quick start (5 min), Feature Highlights. <br> *Rule:* Must be concise, scannable, and inspiring. Use absolute links carefully or rely on the CI transformation. |
| `docs/USER_GUIDE.md` | **Users** | **The Cookbook.** Story-driven scenarios. <br> *Rule:* Focus on "The Scenario" (Problem) and "The Solution". Avoid "QA-style" step-by-step validation. Use natural language. |
| `docs/ARCHITECTURE_AND_FEATURES.md` | **Power Users** | **The Engine Room.** Deep technical explanation. <br> *Rule:* Explain *how* it works (DooD, IDE protocols, networking). Be accurate about trade-offs. |
| `docs/internal/MAINTENANCE_JOURNEYS.md` | **Maintainers** | **The QA Matrix.** Exhaustive checklist of edge cases. <br> *Rule:* Keep it comprehensive. Structure by functional area. **Not for end-users.** |
| `adr/` | **Architects** | **The History.** Decision records. <br> *Rule:* Explain *why* we built it this way. |

### Docker Hub Publishing
*   **Mechanism:** The `README.md` is the source of truth for both GitHub and Docker Hub.
*   **Transformation:** Docker Hub does not support relative links (e.g., `docs/foo.md`). The CI pipeline (via `make docker-readme`) dynamically generates a temporary `README_DOCKER.md`, replacing all relative links with absolute GitHub URLs before publishing.
*   **Cross-Platform Linking:** You **MUST** maintain explicit, high-visibility links to both the GitHub repository and the Docker Hub page at the top of the `README.md`. This ensures that users landing on Docker Hub can find the source code and documentation, and users on GitHub can find the official images.
*   **Rule:** When writing `README.md`, use relative links for better GitHub navigation. Trust the CI to fix them for Docker Hub.
--- End of Context from: GEMINI.md ---


