#!/bin/bash
set -e

# Configuration
DOCKER_HUB_USER="${DOCKER_HUB_USER:-jsebayhi}"
LOCAL_TAG="gemini-cli-toolbox/hub:latest"
REMOTE_TAG="${DOCKER_HUB_USER}/gemini-cli-toolbox:latest-hub"
CONTAINER_NAME="gemini-hub-service"
PORT="8888"

# Auth Key
AUTH_KEY="${GEMINI_REMOTE_KEY:-}"
WORKSPACE_ROOTS=()
CONFIG_ROOT="${HOME}/.gemini/configs"

# Auto-detect config root fallback
if [ ! -d "$CONFIG_ROOT" ] && [ -d "${HOME}/.gemini-profiles" ]; then
    CONFIG_ROOT="${HOME}/.gemini-profiles"
fi

# Parse Args
MODE="-it"
while [[ $# -gt 0 ]]; do
  case $1 in
    -d|--detach) MODE="-d"; shift ;;
    --key)       AUTH_KEY="$2"; shift; shift ;;
    --workspace) WORKSPACE_ROOTS+=("$2"); shift; shift ;;
    --config-root) CONFIG_ROOT="$2"; shift; shift ;;
    stop)
        echo ">> Stopping Gemini Hub..."
        docker stop "$CONTAINER_NAME" >/dev/null 2>&1 || echo ">> Hub is not running."
        exit 0
        ;;
    *)           shift ;; # Ignore unknown args
  esac
done

if [ -z "$AUTH_KEY" ]; then
    echo "Error: TAILSCALE_KEY is required for the Hub."
    echo "Usage: gemini-hub --key tskey-auth-... [--workspace path] [--config-root path]"
    exit 1
fi

# Prepare Docker Args for Mounts
EXTRA_MOUNTS=()
ROOT_PATHS_LIST=""

# 1. Mount Workspace Roots
for root in "${WORKSPACE_ROOTS[@]}"; do
    ABS_ROOT=$(realpath -m "$root")
    if [ -d "$ABS_ROOT" ]; then
        EXTRA_MOUNTS+=("-v" "${ABS_ROOT}:${ABS_ROOT}")
        ROOT_PATHS_LIST="${ROOT_PATHS_LIST}${ABS_ROOT}:"
    else
        echo "Warning: Workspace root '$ABS_ROOT' does not exist. Skipping."
    fi
done
# Remove trailing colon
ROOT_PATHS_LIST=${ROOT_PATHS_LIST%:}

# 2. Mount Config Root
ABS_CONFIG_ROOT=$(realpath -m "$CONFIG_ROOT")
mkdir -p "$ABS_CONFIG_ROOT"
EXTRA_MOUNTS+=("-v" "${ABS_CONFIG_ROOT}:${ABS_CONFIG_ROOT}")

# 3. Persistence (Named Volume)
# We use a Docker Named Volume for the Tailscale state.
# This keeps the host filesystem clean while preventing "New Device" naming collisions (gemini-hub-1).
EXTRA_MOUNTS+=("-v" "gemini-hub-state:/var/lib/tailscale")

# Resolve Image (Local vs Remote)
if docker image inspect "$LOCAL_TAG" >/dev/null 2>&1; then
    IMAGE_NAME="$LOCAL_TAG"
else
    # Fallback to remote image (Docker will auto-pull if missing)
    IMAGE_NAME="$REMOTE_TAG"
fi

echo ">> Starting Gemini Hub on port $PORT..."
echo ">> Access at http://localhost:$PORT (Desktop)"
echo ">> Access at http://gemini-hub:8888 (Mobile VPN)"

# Check if already running
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Error: A Hub instance ('$CONTAINER_NAME') is already running."
    echo "Run 'gemini-hub stop' to shut it down before starting a new one."
    exit 1
fi

# Run Container
docker run --rm $MODE \
    --name "$CONTAINER_NAME" \
    --net=host \
    --cap-add=NET_ADMIN \
    --device /dev/net/tun \
    --volume "/var/run/docker.sock:/var/run/docker.sock" \
    "${EXTRA_MOUNTS[@]}" \
    --env HOST_DOCKER_GID="${HOST_DOCKER_GID}" \
    --env TAILSCALE_AUTH_KEY="$AUTH_KEY" \
    --env HUB_ROOTS="${ROOT_PATHS_LIST}" \
    --env HOST_CONFIG_ROOT="${ABS_CONFIG_ROOT}" \
    --env HOST_HOME="${HOME}" \
    "$IMAGE_NAME"
