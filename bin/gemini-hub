#!/bin/bash
set -e

# Configuration
DOCKER_HUB_USER="${DOCKER_HUB_USER:-jsebayhi}"
LOCAL_TAG="gemini-cli-toolbox/hub:latest"
REMOTE_TAG="${DOCKER_HUB_USER}/gemini-cli-toolbox:latest-hub"
CONTAINER_NAME="gemini-hub-service"
PORT="8888"

# Auth Key
AUTH_KEY="${GEMINI_REMOTE_KEY:-}"
WORKSPACE_ROOTS=()
CONFIG_ROOT="${HOME}/.gemini/configs"

# Auto-detect config root fallback
if [ ! -d "$CONFIG_ROOT" ] && [ -d "${HOME}/.gemini-profiles" ]; then
    CONFIG_ROOT="${HOME}/.gemini-profiles"
fi

# Help Function
show_help() {
    echo "Usage: gemini-hub [OPTIONS] [COMMAND]"
    echo ""
    echo "A dashboard for discovering and connecting to active Gemini sessions via Tailscale."
    echo ""
    echo "Options:"
    echo "  -d, --detach          Start the Hub in the background"
    echo "  --key <key>           Tailscale Auth Key (Required if GEMINI_REMOTE_KEY is not set)"
    echo "  --auto-shutdown       Enable 60s inactivity timeout (Default: Disabled)"
    echo "  --workspace <path>    Add a host directory to the list of scannable project roots"
    echo "                        (Can be specified multiple times)"
    echo "  --config-root <path>  Root directory containing configuration profiles"
    echo "                        (Default: ~/.gemini/configs or ~/.gemini-profiles)"
    echo "  -h, --help            Show this help message"
    echo ""
    echo "Commands:"
    echo "  stop                  Stop the running Gemini Hub service"
    echo ""
    echo "Examples:"
    echo "  gemini-hub --key tskey-auth-xxxx"
    echo "  gemini-hub --workspace ~/projects --workspace /data/repos"
}

# Parse Args
MODE="-it"
AUTO_SHUTDOWN=false
while [[ $# -gt 0 ]]; do
  case $1 in
    -d|--detach) MODE="-d"; shift ;;
    --key)       AUTH_KEY="$2"; shift; shift ;;
    --auto-shutdown) AUTO_SHUTDOWN=true; shift ;;
    --workspace) WORKSPACE_ROOTS+=("$2"); shift; shift ;;
    --config-root) CONFIG_ROOT="$2"; shift; shift ;;
    -h|--help)   show_help; exit 0 ;;
    stop)
        echo ">> Stopping Gemini Hub..."
        docker stop "$CONTAINER_NAME" >/dev/null 2>&1 || echo ">> Hub is not running."
        exit 0
        ;;
    *)           echo "Error: Unknown argument '$1'"; show_help; exit 1 ;;
  esac
done

if [ -z "$AUTH_KEY" ]; then
    echo "Error: TAILSCALE_KEY is required for the Hub."
    echo "Run 'gemini-hub --help' for usage instructions."
    exit 1
fi

# Prepare Docker Args for Mounts
EXTRA_MOUNTS=()
ROOT_PATHS_LIST=""
ENV_VARS=()

if [ "$AUTO_SHUTDOWN" = true ]; then
    ENV_VARS+=("--env" "HUB_AUTO_SHUTDOWN=1")
fi

# --- SMART RESTART LOGIC ---
# Check if Hub is already running
if [ -n "$(docker ps -q -f name="^/${CONTAINER_NAME}$")" ]; then
    echo ">> Hub is already running."
    
    # 1. Introspect existing configuration
    EXISTING_ROOTS_STR=$(docker inspect --format '{{range .Config.Env}}{{println .}}{{end}}' "$CONTAINER_NAME" | grep "^HUB_ROOTS=" | cut -d= -f2-)
    IFS=':' read -ra EXISTING_ROOTS <<< "$EXISTING_ROOTS_STR"
    
    # 2. Check for missing roots
    MISSING_ROOTS=()
    for new_root in "${WORKSPACE_ROOTS[@]}"; do
        ABS_NEW=$(realpath -m "$new_root")
        FOUND=false
        for old_root in "${EXISTING_ROOTS[@]}"; do
            if [[ "$ABS_NEW" == "$old_root"* ]]; then
                FOUND=true
                break
            fi
        done
        if [ "$FOUND" = false ]; then
            MISSING_ROOTS+=("$ABS_NEW")
        fi
    done
    
    # 3. Decision
    if [ ${#MISSING_ROOTS[@]} -eq 0 ]; then
        echo ">> Active Hub already covers all requested workspaces."
        echo ">> Hub URL: http://localhost:$PORT"
        exit 0
    else
        echo ">> Requested workspaces are NOT covered by the active Hub:"
        for r in "${MISSING_ROOTS[@]}"; do echo "   - $r"; done
        
        if [ -t 0 ]; then
            echo ""
            read -p ">> Restart Hub to include them? (Merge/Replace/Cancel) [M/r/c]: " -r RESPONSE
            RESPONSE=${RESPONSE:-M}
            if [[ "$RESPONSE" =~ ^[Mm]$ ]]; then
                # MERGE: Add existing roots to the request list (deduplication happens in mount loop)
                WORKSPACE_ROOTS+=("${EXISTING_ROOTS[@]}")
                echo ">> Stopping old Hub..."
                docker stop "$CONTAINER_NAME" >/dev/null
            elif [[ "$RESPONSE" =~ ^[Rr]$ ]]; then
                # REPLACE: Just stop, keeping only new WORKSPACE_ROOTS
                echo ">> Stopping old Hub..."
                docker stop "$CONTAINER_NAME" >/dev/null
            else
                echo ">> Action cancelled."
                exit 0
            fi
        else
            # Non-interactive: Default to Merge and Restart (Safe behavior for scripts)
            echo ">> Non-interactive mode: Merging roots and restarting..."
            WORKSPACE_ROOTS+=("${EXISTING_ROOTS[@]}")
            docker stop "$CONTAINER_NAME" >/dev/null
        fi
    fi
fi

# 1. Mount Workspace Roots
for root in "${WORKSPACE_ROOTS[@]}"; do
    ABS_ROOT=$(realpath -m "$root")
    if [ -d "$ABS_ROOT" ]; then
        # Deduplication check: Avoid mounting same path twice if merged
        if [[ "$ROOT_PATHS_LIST" != *"$ABS_ROOT"* ]]; then
            EXTRA_MOUNTS+=("-v" "${ABS_ROOT}:${ABS_ROOT}")
            ROOT_PATHS_LIST="${ROOT_PATHS_LIST}${ABS_ROOT}:"
        fi
    else
        echo "Warning: Workspace root '$ABS_ROOT' does not exist. Skipping."
    fi
done
# Remove trailing colon
ROOT_PATHS_LIST=${ROOT_PATHS_LIST%:}

# 2. Mount Config Root
ABS_CONFIG_ROOT=$(realpath -m "$CONFIG_ROOT")
mkdir -p "$ABS_CONFIG_ROOT"
EXTRA_MOUNTS+=("-v" "${ABS_CONFIG_ROOT}:${ABS_CONFIG_ROOT}")

# 3. Persistence (Named Volume)
# We use a Docker Named Volume for the Tailscale state.
# This keeps the host filesystem clean while preventing "New Device" naming collisions (gemini-hub-1).
EXTRA_MOUNTS+=("-v" "gemini-hub-state:/var/lib/tailscale")

# 4. Mount Toolbox Script (Ensure Hub uses latest version)
# Resolve real path of this script to find sibling toolbox script
REAL_SOURCE="${BASH_SOURCE[0]}"
while [ -h "$REAL_SOURCE" ]; do
    DIR="$( cd -P "$( dirname "$REAL_SOURCE" )" >/dev/null 2>&1 && pwd )"
    REAL_SOURCE="$(readlink "$REAL_SOURCE")"
    [[ $REAL_SOURCE != /* ]] && REAL_SOURCE="$DIR/$REAL_SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$REAL_SOURCE" )" >/dev/null 2>&1 && pwd )"
TOOLBOX_SCRIPT="${SCRIPT_DIR}/gemini-toolbox"

if [ -f "$TOOLBOX_SCRIPT" ]; then
    EXTRA_MOUNTS+=("-v" "${TOOLBOX_SCRIPT}:/usr/local/bin/gemini-toolbox")
else
    echo "Warning: gemini-toolbox script not found at $TOOLBOX_SCRIPT. Hub will use embedded version."
fi

# Resolve Image (Local vs Remote)
if docker image inspect "$LOCAL_TAG" >/dev/null 2>&1; then
    IMAGE_NAME="$LOCAL_TAG"
else
    # Fallback to remote image (Docker will auto-pull if missing)
    IMAGE_NAME="$REMOTE_TAG"
fi

# Detect Host Docker GID (for DooD)
# We must calculate this on the HOST and pass it to the container.
HOST_DOCKER_GID=""
if command -v getent >/dev/null 2>&1 && getent group docker >/dev/null 2>&1; then
    HOST_DOCKER_GID=$(getent group docker | cut -d: -f3)
fi

echo ">> Starting Gemini Hub on port $PORT..."
echo ">> Access at http://localhost:$PORT (Desktop)"
echo ">> Access at http://gemini-hub:8888 (Mobile VPN)"

# Run Container
docker run --rm "$MODE" \
    --name "$CONTAINER_NAME" \
    --net=host \
    --cap-add=NET_ADMIN \
    --device /dev/net/tun \
    --volume "/var/run/docker.sock:/var/run/docker.sock" \
    "${EXTRA_MOUNTS[@]}" \
    "${ENV_VARS[@]}" \
    --env HOST_DOCKER_GID="${HOST_DOCKER_GID}" \
    --env HOST_UID="$(id -u)" \
    --env HOST_GID="$(id -g)" \
    --env TAILSCALE_AUTH_KEY="$AUTH_KEY" \
    --env HUB_ROOTS="${ROOT_PATHS_LIST}" \
    --env HOST_CONFIG_ROOT="${ABS_CONFIG_ROOT}" \
    --env HOST_HOME="${HOME}" \
    "$IMAGE_NAME"
