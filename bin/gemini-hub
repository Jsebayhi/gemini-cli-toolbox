#!/bin/bash

# Gemini Hub Wrapper Script
# A dashboard for discovering and connecting to active Gemini sessions via Tailscale.

# 0. Global Defaults & Functions (Source-safe)
# These are safe to load when sourcing the script for testing.

show_help() {
    echo "Usage: gemini-hub [OPTIONS] [COMMAND]"
    echo ""
    echo "A dashboard for discovering and connecting to active Gemini sessions via Tailscale."
    echo ""
    echo "Options:"
    echo "  -d, --detach          Start the Hub in the background"
    echo "  --image <name>        Override the Docker image to use"
    echo "  --key <key>           Tailscale Auth Key (Required if GEMINI_REMOTE_KEY is not set)"
    echo "  --auto-shutdown       Enable 60s inactivity timeout (Default: Disabled)"
    echo "  --no-worktree-prune   Disable background worktree cleanup service"
    echo "  --workspace <path>    Add a host directory to the list of scannable project roots"
    echo "                        (Can be specified multiple times)"
    echo "  --config-root <path>  Root directory containing configuration profiles"
    echo "                        (Default: ~/.gemini/configs or ~/.gemini-profiles)"
    echo "  -h, --help            Show this help message"
    echo ""
    echo "Commands:"
    echo "  stop                  Stop the running Gemini Hub service"
    echo ""
    echo "Examples:"
    echo "  gemini-hub --key tskey-auth-xxxx"
    echo "  gemini-hub --workspace ~/projects --workspace /data/repos"
}

main() {
    set -euo pipefail

    # 0.1 Resolve script location and Repository Root
    local real_source="${BASH_SOURCE[0]}"
    while [ -h "$real_source" ]; do
        local dir
        dir="$( cd -P "$( dirname "$real_source" )" >/dev/null 2>&1 && pwd )"
        real_source="$(readlink "$real_source")"
        [[ $real_source != /* ]] && real_source="$dir/$real_source"
    done
    local script_dir
    script_dir="$( cd -P "$( dirname "$real_source" )" >/dev/null 2>&1 && pwd )"
    local repo_root
    repo_root="$(dirname "$script_dir")"

    # 0.2 Configuration
    local docker_hub_user="${DOCKER_HUB_USER:-jsebayhi}"
    local container_name="gemini-hub-service"
    local port="8888"

    local auth_key="${GEMINI_REMOTE_KEY:-}"
    local workspace_roots=()
    local config_root="${HOME}/.gemini/configs"

    # Auto-detect config root fallback
    if [ ! -d "$config_root" ] && [ -d "${HOME}/.gemini-profiles" ]; then
        config_root="${HOME}/.gemini-profiles"
    fi

    # 1. Pre-scan for Override Image
    local override_image=""
    local iter_hub_args=("$@")
    for ((i=0; i<${#iter_hub_args[@]}; i++)); do
        case "${iter_hub_args[i]}" in
            --image) override_image="${iter_hub_args[i+1]}" ;;
        esac
    done

    # 2. Resolve Image Name (Local vs Remote)
    local branch_suffix=""
    if command -v git >/dev/null 2>&1 && git -C "$repo_root" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        local current_branch
        current_branch=$(git -C "$repo_root" rev-parse --abbrev-ref HEAD 2>/dev/null)
        if [ "$current_branch" != "main" ] && [ -n "$current_branch" ]; then
            local safe_branch="${current_branch//[!a-zA-Z0-9]/-}"
            branch_suffix="-$safe_branch"
        fi
    fi

    local local_tag="gemini-cli-toolbox/hub:latest${branch_suffix}"
    local remote_tag="${docker_hub_user}/gemini-cli-toolbox:latest-hub"
    local image_name=""

    if [ -n "$override_image" ]; then
        image_name="$override_image"
    elif docker image inspect "$local_tag" >/dev/null 2>&1; then
        image_name="$local_tag"
    else
        image_name="$remote_tag"
    fi

    # 3. Parse Args
    local mode="-it"
    local auto_shutdown=false
    local prune_enabled=true
    while [[ $# -gt 0 ]]; do
      case $1 in
        -d|--detach) mode="-d"; shift ;;
        --image)     override_image="$2"; shift; shift ;;
        --key)       auth_key="$2"; shift; shift ;;
        --auto-shutdown) auto_shutdown=true; shift ;;
        --no-worktree-prune) prune_enabled=false; shift ;;
        --workspace) workspace_roots+=("$2"); shift; shift ;;
        --config-root) config_root="$2"; shift; shift ;;
        -h|--help)   show_help; exit 0 ;;
        stop)
            echo ">> Stopping Gemini Hub..."
            docker stop "$container_name" >/dev/null 2>&1 || echo ">> Hub is not running."
            exit 0
            ;;
        *)           echo "Error: Unknown argument '$1'"; show_help; exit 1 ;;
      esac
    done

    if [ -z "$auth_key" ]; then
        echo "Error: TAILSCALE_KEY is required for the Hub."
        echo "Run 'gemini-hub --help' for usage instructions."
        exit 1
    fi

    # 4. Prepare Docker Args
    local extra_mounts=()
    local root_paths_list=""
    local env_vars=()

    if [ "$auto_shutdown" = true ]; then env_vars+=("--env" "HUB_AUTO_SHUTDOWN=1"); fi
    if [ "$prune_enabled" = false ]; then env_vars+=("--env" "HUB_WORKTREE_PRUNE_ENABLED=false"); fi

    # --- SMART RESTART LOGIC ---
    if [ -n "$(docker ps -q -f name="^/${container_name}$")" ]; then
        echo ">> Hub is already running."
        local existing_roots_str
        existing_roots_str=$(docker inspect --format '{{range .Config.Env}}{{println .}}{{end}}' "$container_name" | grep "^HUB_ROOTS=" | cut -d= -f2-)
        local existing_roots=()
        IFS=':' read -ra existing_roots <<< "$existing_roots_str"
        
        local missing_roots=()
        for new_root in "${workspace_roots[@]}"; do
            local abs_new
            abs_new=$(realpath -m "$new_root")
            local found=false
            for old_root in "${existing_roots[@]}"; do
                if [[ "$abs_new" == "$old_root"* ]]; then found=true; break; fi
            done
            if [ "$found" = false ]; then missing_roots+=("$abs_new"); fi
        done
        
        if [ ${#missing_roots[@]} -eq 0 ]; then
            echo ">> Active Hub already covers all requested workspaces."
            echo ">> Hub URL: http://localhost:$port"
            exit 0
        else
            echo ">> Requested workspaces are NOT covered by the active Hub:"
            for r in "${missing_roots[@]}"; do echo "   - $r"; done
            
            if [ -t 0 ]; then
                echo ""
                read -p ">> Restart Hub to include them? (Merge/Replace/Cancel) [M/r/c]: " -r RESPONSE
                RESPONSE=${RESPONSE:-M}
                if [[ "$RESPONSE" =~ ^[Mm]$ ]]; then
                    workspace_roots+=("${existing_roots[@]}")
                    echo ">> Stopping old Hub..."
                    docker stop "$container_name" >/dev/null
                elif [[ "$RESPONSE" =~ ^[Rr]$ ]]; then
                    echo ">> Stopping old Hub..."
                    docker stop "$container_name" >/dev/null
                else
                    echo ">> Action cancelled."
                    exit 0
                fi
            else
                echo ">> Non-interactive mode: Merging roots and restarting..."
                workspace_roots+=("${existing_roots[@]}")
                docker stop "$container_name" >/dev/null
            fi
        fi
    fi

    for root in "${workspace_roots[@]}"; do
        local abs_root
        abs_root=$(realpath -m "$root")
        if [ -d "$abs_root" ]; then
            if [[ "$root_paths_list" != *"$abs_root"* ]]; then
                extra_mounts+=("-v" "${abs_root}:${abs_root}")
                root_paths_list="${root_paths_list}${abs_root}:"
            fi
        else
            echo "Warning: Workspace root '$abs_root' does not exist. Skipping."
        fi
    done
    root_paths_list=${root_paths_list%:}

    local abs_config_root
    abs_config_root=$(realpath -m "$config_root")
    mkdir -p "$abs_config_root"
    extra_mounts+=("-v" "${abs_config_root}:${abs_config_root}")

    local worktree_cache="${GEMINI_WORKTREE_ROOT:-${XDG_CACHE_HOME:-$HOME/.cache}/gemini-toolbox/worktrees}"
    mkdir -p "$worktree_cache"
    local abs_worktree_cache
    abs_worktree_cache=$(realpath -m "$worktree_cache")
    extra_mounts+=("-v" "${abs_worktree_cache}:${abs_worktree_cache}")
    env_vars+=("--env" "GEMINI_WORKTREE_ROOT=${abs_worktree_cache}")

    if [ -n "${GEMINI_WORKTREE_HEADLESS_EXPIRY_DAYS:-}" ]; then env_vars+=("--env" "GEMINI_WORKTREE_HEADLESS_EXPIRY_DAYS=${GEMINI_WORKTREE_HEADLESS_EXPIRY_DAYS}"); fi
    if [ -n "${GEMINI_WORKTREE_BRANCH_EXPIRY_DAYS:-}" ]; then env_vars+=("--env" "GEMINI_WORKTREE_BRANCH_EXPIRY_DAYS=${GEMINI_WORKTREE_BRANCH_EXPIRY_DAYS}"); fi
    if [ -n "${GEMINI_WORKTREE_ORPHAN_EXPIRY_DAYS:-}" ]; then env_vars+=("--env" "GEMINI_WORKTREE_ORPHAN_EXPIRY_DAYS=${GEMINI_WORKTREE_ORPHAN_EXPIRY_DAYS}"); fi

    extra_mounts+=("-v" "gemini-hub-state:/var/lib/tailscale")

    local toolbox_script="${script_dir}/gemini-toolbox"
    if [ -f "$toolbox_script" ]; then
        extra_mounts+=("-v" "${toolbox_script}:/usr/local/bin/gemini-toolbox")
    else
        echo "Warning: gemini-toolbox script not found at $toolbox_script. Hub will use embedded version."
    fi

    local host_docker_gid=""
    if command -v getent >/dev/null 2>&1 && getent group docker >/dev/null 2>&1; then
        host_docker_gid=$(getent group docker | cut -d: -f3)
    fi

    echo ">> Starting Gemini Hub on port $port..."
    echo ">> Access at http://localhost:$port (Desktop)"
    echo ">> Access at http://gemini-hub:8888 (Mobile VPN)"

    docker run --rm "$mode" \
        --name "$container_name" \
        --net=host \
        --cap-add=NET_ADMIN \
        --device /dev/net/tun \
        --volume "/var/run/docker.sock:/var/run/docker.sock" \
        "${extra_mounts[@]}" \
        "${env_vars[@]}" \
        --env HOST_DOCKER_GID="${host_docker_gid}" \
        --env HOST_UID="$(id -u)" \
        --env HOST_GID="$(id -g)" \
        --env TAILSCALE_AUTH_KEY="$auth_key" \
        --env HUB_ROOTS="${root_paths_list}" \
        --env HOST_CONFIG_ROOT="${abs_config_root}" \
        --env HOST_HOME="${HOME}" \
        --env TERM \
        --env COLORTERM \
        "$image_name"
}

# Entry point guard
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
