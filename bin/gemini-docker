#!/bin/bash

# Configuration
HOST_CONF_DIR="${HOME}/.gemini"
PROJECT_DIR="$(pwd)"
IMAGE_NAME="gemini-cli:latest"
USE_BASH=false
EXTRA_DOCKER_ARGS=()

# Help Function
show_help() {
    echo "Usage: gemini-docker [OPTIONS] [-- APP_ARGS]"
    echo ""
    echo "Options:"
    echo "  --full               Use the full image (Java 8/17/21, Go, Scala)"
    echo "  --preview            Use the preview image (Latest Beta CLI)"
    echo "  --config <path>      Path to configuration directory (default: ~/.gemini)"
    echo "  --project <path>     Path to project directory to mount as workspace (default: current dir)"
    echo "  --docker-args <str>  Additional arguments passed to 'docker run' (e.g., mounts)"
    echo "  --bash               Start a bash shell instead of the Gemini CLI"
    echo "  --help               Show this help message"
    echo ""
    echo "Examples:"
    echo "  gemini-docker chat"
    echo "  gemini-docker --preview chat"
    echo "  gemini-docker --config ~/.gemini-work -- --help"
    echo "  gemini-docker --docker-args '-v /opt/ext:/ext' chat"
}

# 1. Parse Arguments
ARGS=()
while [[ $# -gt 0 ]]; do
  case $1 in
    --full)        IMAGE_NAME="gemini-cli-full:latest"; shift ;;
    --preview)     IMAGE_NAME="gemini-cli-preview:latest"; shift ;;
    --config)      HOST_CONF_DIR="$2"; shift; shift ;;
    --project)     PROJECT_DIR="$2";   shift; shift ;;
    --bash)        USE_BASH=true;      shift ;;
    --docker-args) 
        read -ra SPLIT_ARGS <<< "$2"
        EXTRA_DOCKER_ARGS+=("${SPLIT_ARGS[@]}")
        shift; shift 
        ;; 
    -v|--volume)
        EXTRA_DOCKER_ARGS+=("-v" "$2")
        shift; shift
        ;;
    --help)        show_help; exit 0 ;;
    --)            shift; ARGS+=("$@"); break ;;
    *)             ARGS+=("$1");       shift ;;
  esac
done

# 2. Setup Directories
HOST_CONF_DIR=$(realpath -m "$HOST_CONF_DIR")
mkdir -p "$HOST_CONF_DIR"

# 2.1 Pre-create Host Cache Directories (As User)
# We do this to prevent Docker from creating them as 'root' if they don't exist
REQUIRED_DIRS=(
    "${HOME}/.m2"
    "${HOME}/.gradle"
    "${HOME}/.sbt"
    "${HOME}/.ivy2"
    "${HOME}/.cache/coursier"
    "${HOME}/go/pkg/mod"
    "${HOME}/.cache/go-build"
)

for dir in "${REQUIRED_DIRS[@]}"; do
    if [ ! -d "$dir" ]; then
        # echo "Initializing missing cache directory: $dir"
        mkdir -p "$dir"
    fi
done

PROJECT_DIR=$(realpath -m "$PROJECT_DIR")
if [ ! -d "$PROJECT_DIR" ]; then
    echo "Error: Project directory '$PROJECT_DIR' does not exist." >&2
    exit 1
fi

# Extract project name for prettier mount point
PROJECT_NAME=$(basename "$PROJECT_DIR")

# 3. Build Docker Command
DOCKER_CMD=(
  docker run --rm -it
  --net=host
  --volume "${PROJECT_DIR}:/home/gemini/${PROJECT_NAME}"
  --volume "${HOST_CONF_DIR}:/home/gemini/.gemini"
  # Shared Host Caches (Performance & Convenience)
  --volume "${HOME}/.m2:/home/gemini/.m2"
  --volume "${HOME}/.gradle:/home/gemini/.gradle"
  --volume "${HOME}/.sbt:/home/gemini/.sbt"
  --volume "${HOME}/.ivy2:/home/gemini/.ivy2"
  --volume "${HOME}/.cache/coursier:/home/gemini/.cache/coursier"
  --volume "${HOME}/go/pkg/mod:/home/gemini/go/pkg/mod"
  --volume "${HOME}/.cache/go-build:/home/gemini/.cache/go-build"
  --env DEFAULT_UID="$(id -u)"
  --env DEFAULT_GID="$(id -g)"
  --env TERM
  --env LANG
  --env LC_ALL
  --env HTTP_PROXY --env HTTPS_PROXY --env NO_PROXY
  --env http_proxy --env https_proxy --env no_proxy
  --workdir "/home/gemini/${PROJECT_NAME}"
  "${EXTRA_DOCKER_ARGS[@]}"
)

# 4. Execute
if [ "$USE_BASH" = true ]; then
    echo "Starting in BASH mode..."
    "${DOCKER_CMD[@]}" \
      --entrypoint /usr/local/bin/docker-entrypoint.sh \
      "$IMAGE_NAME" bash
else
    "${DOCKER_CMD[@]}" \
      "$IMAGE_NAME" "${ARGS[@]}"
fi
